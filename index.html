<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Terminal</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-color: #000;
            --text-color: #0f0;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            line-height: 1.4;
            padding: 20px;
            height: 100vh;
            overflow-y: auto;
            cursor: pointer;
        }

        .prompt {
            color: var(--text-color);
            margin-bottom: 0;
            width: fit-content;
            padding: 0;
        }

        .command-block {
            margin-bottom: 5px;
        }

        .command {
            color: var(--text-color);
        }

        .output {
            color: var(--text-color);
            white-space: pre;
            margin: 0;
            line-height: 1.4;
            width: fit-content;
            padding: 0;
        }

        .cursor {
            display: inline-block;
            width: 8px;
            height: 16px;
            background-color: var(--text-color);
            animation: blink 1s infinite;
            vertical-align: middle;
        }

        @keyframes blink {
            0%, 49% { opacity: 1; }
            50%, 100% { opacity: 0; }
        }

        .terminal-input {
            background: transparent;
            border: none;
            outline: none;
            color: var(--text-color);
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            width: 1ch;
            min-width: 1ch;
            caret-color: transparent;
        }

        .gear-icon {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.25;
            transition: opacity 0.3s;
            z-index: 1000;
            color: var(--text-color);
            user-select: none;
            padding: 10px;
        }

        .gear-icon:hover {
            opacity: 0.5;
        }

        .clear-icon {
            position: fixed;
            bottom: 20px;
            right: 60px;
            font-size: 20px;
            cursor: pointer;
            opacity: 0.25;
            transition: opacity 0.3s;
            z-index: 1000;
            color: var(--text-color);
            user-select: none;
            padding: 10px;
        }

        .clear-icon:hover {
            opacity: 0.5;
        }

        .config-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            padding: 40px;
            overflow-y: auto;
        }

        .config-modal.active {
            display: block;
        }

        .config-content {
            max-width: 800px;
            margin: 0 auto;
            background-color: var(--bg-color);
            padding: 20px;
        }

        .config-header {
            margin-bottom: 20px;
        }

        .config-header h2 {
            color: var(--text-color);
            font-size: 20px;
        }

        .theme-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--text-color);
        }

        .theme-section h3 {
            color: var(--text-color);
            font-size: 16px;
            margin-bottom: 10px;
        }

        .theme-controls {
            display: flex;
            gap: 20px;
        }

        .theme-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .theme-control label {
            color: var(--text-color);
        }

        .theme-control select {
            background-color: var(--bg-color);
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 10px;
            font-family: 'Courier New', Courier, monospace;
            cursor: pointer;
        }

        .theme-control select option {
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        .about-section {
            color: var(--text-color);
            margin-bottom: 30px;
            padding: 20px;
            border: 2px solid var(--text-color);
            line-height: 1.6;
            background: linear-gradient(135deg, rgba(128, 128, 128, 0.15) 0%, rgba(128, 128, 128, 0.05) 100%);
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.15), inset 0 0 30px rgba(255, 255, 255, 0.03);
        }

        .about-section p {
            margin: 5px 0;
        }

        .about-section a {
            color: var(--text-color);
            text-decoration: underline;
        }

        .about-section a:hover {
            opacity: 0.7;
        }

        .help-toggle {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            margin-top: 10px;
            font-size: 12px;
        }

        .help-toggle:hover {
            opacity: 0.7;
        }

        .help-content {
            margin-top: 10px;
        }

        .close-btn {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 5px 15px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
        }

        .close-btn:hover {
            opacity: 0.7;
        }

        .command-pair {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid var(--text-color);
        }

        .command-pair label {
            display: block;
            color: var(--text-color);
            margin-bottom: 5px;
        }

        .command-pair input {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 8px;
            font-family: 'Courier New', Courier, monospace;
            margin-bottom: 10px;
        }

        .command-pair textarea {
            width: 100%;
            background-color: var(--bg-color);
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 8px;
            font-family: 'Courier New', Courier, monospace;
            min-height: 100px;
            resize: vertical;
        }

        .remove-pair {
            background: none;
            border: 1px solid #f00;
            color: #f00;
            padding: 5px 10px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
            margin-top: 10px;
        }

        .remove-pair:hover {
            background-color: #f00;
            color: var(--bg-color);
        }

        .config-actions {
            margin-top: 30px;
            display: flex;
            gap: 10px;
        }

        .config-actions button {
            background: none;
            border: 1px solid var(--text-color);
            color: var(--text-color);
            padding: 10px 20px;
            cursor: pointer;
            font-family: 'Courier New', Courier, monospace;
        }

        .config-actions button:hover {
            opacity: 0.7;
        }

        .welcome-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.98);
            z-index: 3000;
            padding: 40px;
            overflow-y: auto;
        }

        .welcome-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .welcome-content {
            max-width: 600px;
            background-color: var(--bg-color);
            border: 2px solid var(--text-color);
            padding: 30px;
            position: relative;
            box-shadow: 0 0 20px var(--text-color);
        }

        .welcome-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .welcome-header h2 {
            color: var(--text-color);
            font-size: 24px;
            margin: 0;
        }

        .close-x {
            background: none;
            border: none;
            color: var(--text-color);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
            width: 30px;
            height: 30px;
        }

        .close-x:hover {
            opacity: 0.7;
        }

        .welcome-body {
            color: var(--text-color);
            line-height: 1.8;
            margin-bottom: 20px;
        }

        .welcome-body p {
            margin: 10px 0;
        }

        .welcome-body a {
            color: var(--text-color);
            text-decoration: underline;
        }

        .welcome-body a:hover {
            opacity: 0.7;
        }

        .welcome-footer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--text-color);
        }

        .welcome-footer input[type="checkbox"] {
            cursor: pointer;
        }

        .welcome-footer label {
            color: var(--text-color);
            cursor: pointer;
            user-select: none;
        }
    </style>
</head>
<body>
    <div class="prompt" id="initialPrompt"><input type="text" class="terminal-input" id="terminalInput" autofocus><span class="cursor"></span></div>

    <!-- Clear Screen Icon -->
    <div class="clear-icon" id="clearIcon">ðŸ—‘</div>
    
    <!-- Gear Icon -->
    <div class="gear-icon" id="gearIcon">âš™</div>

    <!-- Welcome Modal -->
    <div class="welcome-modal" id="welcomeModal">
        <div class="welcome-content">
            <div class="welcome-header">
                <h2>Welcome to Terminal Emulator</h2>
                <button class="close-x" id="closeWelcome">Ã—</button>
            </div>
            <div class="welcome-body">
                <p>By Jakub Suchy &lt;<a href="mailto:jakub@allthingsdemo.com">jakub@allthingsdemo.com</a>&gt; - I create custom Interactive Demos.</p>
                <p>Make easy <a href="https://navattic.com?utm_source=allthingsdemo_terminal" target="_blank">Navattic</a> shell interactive demos</p>
                <p><strong>Features:</strong></p>
                <p>â€¢ Type commands and press Enter to execute</p>
                <p>â€¢ Click anywhere to cycle through configured commands</p>
                <p>â€¢ Predictable div IDs for easy targeting</p>
                <p>â€¢ Each command & output is a unique div</p>
                <p>â€¢ Configurable command/output pairs</p>
                <p>â€¢ Use the gear icon (âš™) in the bottom right for settings</p>
                <p>â€¢ Use the trash icon (ðŸ—‘) to clear the screen</p>
            </div>
            <div class="welcome-footer">
                <input type="checkbox" id="dontShowAgain">
                <label for="dontShowAgain">Don't show this again</label>
            </div>
        </div>
    </div>

    <!-- Config Modal -->
    <div class="config-modal" id="configModal">
        <div class="config-content">
            <div class="config-header">
                <h2>Terminal Configuration</h2>
            </div>
            <div class="about-section">
                <p>By Jakub Suchy &lt;<a href="mailto:jakub@allthingsdemo.com">jakub@allthingsdemo.com</a>&gt; - I create custom Interactive Demos.</p>
                <p>Make easy <a href="https://navattic.com?utm_source=allthingsdemo_terminal" target="_blank">Navattic</a> shell interactive demos</p>
                <button id="toggleHelp" class="help-toggle">Show Help</button>
                <div id="helpContent" class="help-content" style="display: none;">
                    <p style="margin-top: 15px;"><strong>Features:</strong></p>
                    <p>â€¢ Type commands and press Enter to execute</p>
                    <p>â€¢ Click anywhere to cycle through configured commands</p>
                    <p>â€¢ Predictable div IDs for easy targeting</p>
                    <p>â€¢ Each command & output is a unique div</p>
                    <p>â€¢ Configurable command/output pairs</p>
                    <p>â€¢ Use the gear icon (âš™) in the bottom right for settings</p>
                    <p>â€¢ Use the trash icon (ðŸ—‘) to clear the screen</p>
                </div>
            </div>
            <div class="theme-section">
                <h3>Theme</h3>
                <div class="theme-controls">
                    <div class="theme-control">
                        <label>Background:</label>
                        <select id="bgTheme">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                    <div class="theme-control">
                        <label>Text:</label>
                        <select id="textTheme">
                            <option value="black">Black</option>
                            <option value="white">White</option>
                            <option value="green" selected>Green</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="theme-section">
                <h3>Prompt</h3>
                <div class="theme-control" style="width: 100%;">
                    <label>Command Prompt:</label>
                    <input type="text" id="promptInput" style="flex: 1; background-color: var(--bg-color); border: 1px solid var(--text-color); color: var(--text-color); padding: 5px 10px; font-family: 'Courier New', Courier, monospace;">
                </div>
            </div>
            <div id="commandPairs"></div>
            <div class="config-actions">
                <button id="addPair">Add Command Pair</button>
                <button id="saveConfig">Save Configuration</button>
                <button id="resetConfig">Reset to Default</button>
                <button id="copyURL">Copy Unique URL</button>
                <button class="close-btn" id="closeConfig">Close</button>
            </div>
        </div>
    </div>

    <script>
        let clickCount = 0;
        let commandPairs = [];
        let currentTheme = {
            background: 'dark',
            text: 'green'
        };
        const DEFAULT_PROMPT = 'user@terminal:~$';
        let currentPrompt = DEFAULT_PROMPT;

        // Generate unique ID
        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // UTF-8 safe base64 encoding
        function utf8ToBase64(str) {
            const bytes = new TextEncoder().encode(str);
            let binary = '';
            for (let i = 0; i < bytes.length; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }

        function base64ToUtf8(b64) {
            const binary = atob(b64);
            const bytes = new Uint8Array(binary.length);
            for (let i = 0; i < binary.length; i++) {
                bytes[i] = binary.charCodeAt(i);
            }
            return new TextDecoder().decode(bytes);
        }

        // Build shareable URL from current settings
        function buildSettingsURL() {
            const settings = {
                commands: commandPairs,
                theme: currentTheme,
                prompt: currentPrompt
            };
            const encoded = utf8ToBase64(JSON.stringify(settings));
            const url = new URL(window.location.href);
            url.search = '';
            url.searchParams.set('settings', encoded);
            return url.toString();
        }

        // Load settings from URL query parameter, saving them to localStorage
        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('settings');
            if (!encoded) return;
            try {
                const settings = JSON.parse(base64ToUtf8(encoded));
                if (settings.commands) {
                    localStorage.setItem('terminalConfig', JSON.stringify(settings.commands));
                }
                if (settings.theme) {
                    localStorage.setItem('terminalTheme', JSON.stringify(settings.theme));
                }
                if (settings.prompt) {
                    localStorage.setItem('terminalPrompt', settings.prompt);
                }
                // Clean the URL without reloading
                window.history.replaceState({}, '', window.location.pathname);
            } catch (e) {
                console.error('Failed to load settings from URL:', e);
            }
        }

        // Apply theme to page
        function applyTheme() {
            const bgColor = currentTheme.background === 'dark' ? '#000' : '#fff';
            const textColor = currentTheme.text === 'green' ? '#0f0' : 
                            currentTheme.text === 'white' ? '#fff' : '#000';
            
            document.documentElement.style.setProperty('--bg-color', bgColor);
            document.documentElement.style.setProperty('--text-color', textColor);
        }

        // Load theme from localStorage
        function loadTheme() {
            const saved = localStorage.getItem('terminalTheme');
            if (saved) {
                try {
                    currentTheme = JSON.parse(saved);
                } catch (e) {
                    currentTheme = { background: 'dark', text: 'green' };
                }
            }
            applyTheme();
        }

        // Save theme to localStorage
        function saveTheme() {
            localStorage.setItem('terminalTheme', JSON.stringify(currentTheme));
        }

        // Load prompt from localStorage
        function loadPrompt() {
            const saved = localStorage.getItem('terminalPrompt');
            if (saved) {
                currentPrompt = saved;
            } else {
                currentPrompt = DEFAULT_PROMPT;
            }
        }

        // Save prompt to localStorage
        function savePrompt() {
            localStorage.setItem('terminalPrompt', currentPrompt);
        }

        // Validate theme combination
        function isValidTheme(bg, text) {
            if (bg === 'light' && text === 'white') return false;
            if (bg === 'dark' && text === 'black') return false;
            return true;
        }

        // Default commands
        const defaultCommands = [
            {
                id: generateId(),
                command: 'ls',
                output: `Click_Anywhere_to_Continue
Use_Gear_Bottom_Right_for_Settings
Documents
Downloads`
            },
            {
                id: generateId(),
                command: 'ls -l',
                output: `total 48
drwxr-xr-x  2 user user 4096 Jan 15 10:23 Documents
drwxr-xr-x  2 user user 4096 Jan 15 09:45 Downloads
drwxr-xr-x  2 user user 4096 Jan 14 14:32 Pictures
drwxr-xr-x  2 user user 4096 Jan 13 08:15 Music
drwxr-xr-x  2 user user 4096 Jan 12 16:47 Videos
drwxr-xr-x  5 user user 4096 Jan 16 11:20 projects
-rw-r--r--  1 user user 2048 Jan 15 13:56 notes.txt
-rw-r--r--  1 user user 1024 Jan 14 09:30 readme.md`
            }
        ];

        // Load configuration from localStorage or use defaults
        function loadConfig() {
            const saved = localStorage.getItem('terminalConfig');
            if (saved) {
                try {
                    commandPairs = JSON.parse(saved);
                    // Ensure all pairs have IDs (for backwards compatibility)
                    commandPairs.forEach(pair => {
                        if (!pair.id) {
                            pair.id = generateId();
                        }
                    });
                } catch (e) {
                    commandPairs = [...defaultCommands];
                }
            } else {
                commandPairs = [...defaultCommands];
            }
        }

        // Save configuration to localStorage
        function saveConfig() {
            localStorage.setItem('terminalConfig', JSON.stringify(commandPairs));
        }

        // Render command pairs in config modal
        function renderConfigPairs() {
            const container = document.getElementById('commandPairs');
            container.innerHTML = '';
            
            commandPairs.forEach((pair, index) => {
                const pairDiv = document.createElement('div');
                pairDiv.className = 'command-pair';
                pairDiv.innerHTML = `
                    <label>Command:</label>
                    <input type="text" class="command-input" data-index="${index}" value="${pair.command || ''}">
                    <label>Output:</label>
                    <textarea class="output-input" data-index="${index}">${pair.output || ''}</textarea>
                    <button class="remove-pair" data-index="${index}">Remove</button>
                `;
                container.appendChild(pairDiv);
            });

            // Add event listeners for inputs
            document.querySelectorAll('.command-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    commandPairs[index].command = e.target.value;
                });
            });

            document.querySelectorAll('.output-input').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    commandPairs[index].output = e.target.value;
                });
            });

            document.querySelectorAll('.remove-pair').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = parseInt(e.target.dataset.index);
                    commandPairs.splice(index, 1);
                    renderConfigPairs();
                });
            });
        }

        // Initialize â€” URL settings override localStorage
        loadFromURL();
        loadTheme();
        loadConfig();
        loadPrompt();

        // Set theme select values
        document.getElementById('bgTheme').value = currentTheme.background;
        document.getElementById('textTheme').value = currentTheme.text;

        // Set prompt input value
        document.getElementById('promptInput').value = currentPrompt;

        // Prompt input change handler
        document.getElementById('promptInput').addEventListener('input', (e) => {
            currentPrompt = e.target.value || DEFAULT_PROMPT;
            savePrompt();
        });

        // Set initial prompt text
        const initialPromptEl = document.getElementById('initialPrompt');
        initialPromptEl.insertBefore(document.createTextNode(currentPrompt + ' '), initialPromptEl.firstChild);

        // Focus the terminal input
        const terminalInput = document.getElementById('terminalInput');
        terminalInput.focus();

        // Theme change handlers with validation
        document.getElementById('bgTheme').addEventListener('change', (e) => {
            const newBg = e.target.value;
            const currentText = document.getElementById('textTheme').value;
            
            if (!isValidTheme(newBg, currentText)) {
                // Auto-adjust text color to make it valid
                if (newBg === 'light') {
                    document.getElementById('textTheme').value = 'black';
                    currentTheme.text = 'black';
                } else {
                    document.getElementById('textTheme').value = 'white';
                    currentTheme.text = 'white';
                }
            }
            
            currentTheme.background = newBg;
            saveTheme();
            applyTheme();
        });

        document.getElementById('textTheme').addEventListener('change', (e) => {
            const newText = e.target.value;
            const currentBg = document.getElementById('bgTheme').value;
            
            if (!isValidTheme(currentBg, newText)) {
                alert('Invalid color combination! Light background needs dark text, and dark background needs light text.');
                // Revert to previous value
                e.target.value = currentTheme.text;
                return;
            }
            
            currentTheme.text = newText;
            saveTheme();
            applyTheme();
        });

        // Check if welcome modal should be shown
        function checkWelcomeModal() {
            const dontShow = localStorage.getItem('terminalWelcomeDontShow');
            if (!dontShow) {
                document.getElementById('welcomeModal').classList.add('active');
            }
        }

        // Show welcome modal on first load
        checkWelcomeModal();

        // Close welcome modal
        document.getElementById('closeWelcome').addEventListener('click', (e) => {
            e.stopPropagation();
            const dontShow = document.getElementById('dontShowAgain').checked;
            if (dontShow) {
                localStorage.setItem('terminalWelcomeDontShow', 'true');
            }
            document.getElementById('welcomeModal').classList.remove('active');
        });

        // Also close welcome modal if clicking outside
        document.getElementById('welcomeModal').addEventListener('click', (e) => {
            if (e.target.id === 'welcomeModal') {
                const dontShow = document.getElementById('dontShowAgain').checked;
                if (dontShow) {
                    localStorage.setItem('terminalWelcomeDontShow', 'true');
                }
                document.getElementById('welcomeModal').classList.remove('active');
            }
        });

        // Execute a command and show output
        function executeCommand(typedCommand) {
            // Handle clear command
            if (typedCommand.trim() === 'clear') {
                document.querySelectorAll('.command-block').forEach(block => block.remove());
                document.querySelectorAll('.prompt').forEach(prompt => prompt.remove());
                document.querySelectorAll('.command').forEach(cmd => cmd.remove());
                const newPrompt = document.createElement('div');
                newPrompt.className = 'prompt';
                newPrompt.innerHTML = `${currentPrompt} <input type="text" class="terminal-input" autofocus><span class="cursor"></span>`;
                document.body.insertBefore(newPrompt, document.getElementById('clearIcon'));
                const newInput = newPrompt.querySelector('.terminal-input');
                newInput.focus();
                newInput.addEventListener('keydown', handleInputKeydown);
                newInput.addEventListener('input', handleInputChange);
                return;
            }

            // Find the current prompt with input
            const currentPromptEl = document.querySelector('.prompt');
            if (!currentPromptEl) return;

            // Get the input element
            const input = currentPromptEl.querySelector('.terminal-input');
            const cursor = currentPromptEl.querySelector('.cursor');

            // Convert prompt to static command display
            if (input) input.remove();
            if (cursor) cursor.remove();
            
            // Update the prompt to show the typed command
            currentPromptEl.className = 'command';
            currentPromptEl.id = `command-${generateId()}`;
            currentPromptEl.textContent = `${currentPrompt} ${typedCommand}`;

            // Find matching command pair
            const matchedPair = commandPairs.find(pair => pair.command.trim() === typedCommand.trim());
            
            // Create output
            const commandBlock = document.createElement('div');
            commandBlock.className = 'command-block';
            commandBlock.id = `command-block-${generateId()}`;

            if (matchedPair && matchedPair.output) {
                const outputLines = matchedPair.output.split('\n');
                outputLines.forEach((line, lineIndex) => {
                    const lineDiv = document.createElement('div');
                    lineDiv.className = 'output';
                    lineDiv.id = `output-line-${matchedPair.id}-${lineIndex}`;
                    lineDiv.textContent = line;
                    commandBlock.appendChild(lineDiv);
                });
            } else if (typedCommand.trim() !== '') {
                // Show command not found for non-empty commands
                const errorDiv = document.createElement('div');
                errorDiv.className = 'output';
                errorDiv.id = `output-error-${generateId()}`;
                errorDiv.textContent = `${typedCommand}: command not found`;
                commandBlock.appendChild(errorDiv);
            }

            // Insert output after the command
            currentPromptEl.after(commandBlock);

            // Create new prompt with input
            createNewPrompt();

            // Scroll to bottom
            window.scrollTo(0, document.body.scrollHeight);
        }

        // Create a new prompt with input
        function createNewPrompt() {
            const newPrompt = document.createElement('div');
            newPrompt.className = 'prompt';
            newPrompt.innerHTML = `${currentPrompt} <input type="text" class="terminal-input" autofocus><span class="cursor"></span>`;
            document.body.appendChild(newPrompt);

            // Focus the new input
            const newInput = newPrompt.querySelector('.terminal-input');
            newInput.focus();

            // Add listeners to new input
            newInput.addEventListener('keydown', handleInputKeydown);
            newInput.addEventListener('input', handleInputChange);
        }

        // Handle input keydown
        function handleInputKeydown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const typedCommand = e.target.value;
                executeCommand(typedCommand);
            }
        }

        // Resize input to fit content
        function resizeInput(input) {
            input.style.width = Math.max(1, input.value.length) + 'ch';
        }

        // Handle input typing
        function handleInputChange(e) {
            resizeInput(e.target);
        }

        // Add listeners to initial input
        document.getElementById('terminalInput').addEventListener('keydown', handleInputKeydown);
        document.getElementById('terminalInput').addEventListener('input', handleInputChange);

        // Terminal click handler - cycle through commands
        document.body.addEventListener('click', function(e) {
            // Don't trigger if clicking on gear icon, clear icon, modal, or input
            if (e.target.closest('.gear-icon') || e.target.closest('.clear-icon') || e.target.closest('.config-modal') || e.target.closest('.welcome-modal') || e.target.closest('.terminal-input')) {
                return;
            }

            // Get current command pair (cycle through available pairs)
            const pairIndex = clickCount % commandPairs.length;
            const currentPair = commandPairs[pairIndex];

            // Execute the command from the cycle
            const input = document.querySelector('.terminal-input');
            if (input) {
                input.value = currentPair.command;
            }
            executeCommand(currentPair.command);

            clickCount++;
        });

        // Gear icon click
        document.getElementById('gearIcon').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('configModal').classList.add('active');
            renderConfigPairs();
        });

        // Toggle help in config modal
        document.getElementById('toggleHelp').addEventListener('click', (e) => {
            e.stopPropagation();
            const helpContent = document.getElementById('helpContent');
            const toggleBtn = document.getElementById('toggleHelp');
            if (helpContent.style.display === 'none') {
                helpContent.style.display = 'block';
                toggleBtn.textContent = 'Hide Help';
            } else {
                helpContent.style.display = 'none';
                toggleBtn.textContent = 'Show Help';
            }
        });

        // Clear screen click
        document.getElementById('clearIcon').addEventListener('click', (e) => {
            e.stopPropagation();
            // Remove all command blocks
            document.querySelectorAll('.command-block').forEach(block => block.remove());
            // Remove all prompts and commands
            document.querySelectorAll('.prompt').forEach(prompt => prompt.remove());
            document.querySelectorAll('.command').forEach(cmd => cmd.remove());
            // Add fresh prompt with input
            const newPrompt = document.createElement('div');
            newPrompt.className = 'prompt';
            newPrompt.innerHTML = `${currentPrompt} <input type="text" class="terminal-input" autofocus><span class="cursor"></span>`;
            document.body.insertBefore(newPrompt, document.getElementById('clearIcon'));
            // Focus and add listeners
            const newInput = newPrompt.querySelector('.terminal-input');
            newInput.focus();
            newInput.addEventListener('keydown', handleInputKeydown);
            newInput.addEventListener('input', handleInputChange);
        });

        // Close modal
        document.getElementById('closeConfig').addEventListener('click', (e) => {
            e.stopPropagation();
            document.getElementById('configModal').classList.remove('active');
        });

        // Add pair
        document.getElementById('addPair').addEventListener('click', (e) => {
            e.stopPropagation();
            commandPairs.push({ id: generateId(), command: '', output: '' });
            renderConfigPairs();
        });

        // Save configuration
        document.getElementById('saveConfig').addEventListener('click', (e) => {
            e.stopPropagation();
            saveConfig();
            alert('Configuration saved!');
        });

        // Copy unique URL
        document.getElementById('copyURL').addEventListener('click', (e) => {
            e.stopPropagation();
            const url = buildSettingsURL();
            navigator.clipboard.writeText(url).then(() => {
                alert('URL copied to clipboard!');
            }, () => {
                // Fallback: show the URL so user can copy manually
                prompt('Copy this URL:', url);
            });
        });

        // Reset to default
        document.getElementById('resetConfig').addEventListener('click', (e) => {
            e.stopPropagation();
            if (confirm('Reset to default configuration?')) {
                commandPairs = [...defaultCommands];
                // Generate new IDs for the default commands
                commandPairs.forEach(pair => {
                    pair.id = generateId();
                });
                saveConfig();
                renderConfigPairs();
                // Reset prompt to default
                currentPrompt = DEFAULT_PROMPT;
                savePrompt();
                document.getElementById('promptInput').value = currentPrompt;
            }
        });

        // Prevent clicks inside modal from closing it
        document.getElementById('configModal').addEventListener('click', (e) => {
            if (e.target.id === 'configModal') {
                document.getElementById('configModal').classList.remove('active');
            }
        });
    </script>
</body>
</html>
